<!DOCTYPE html>
<html>
<head>
    <title>Fast Minecraft Clock Sync</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; max-width: 900px; margin: auto; padding: 20px; }
        .clock-card { background: #2d2d2d; padding: 15px; margin: 10px 0; border-radius: 8px; display: grid; grid-template-columns: 1.2fr 1fr 1.2fr; gap: 15px; border: 1px solid #444; }
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        input, select { padding: 8px; border-radius: 4px; border: 1px solid #555; background: #333; color: white; width: 100%; }
        #output { background: #000; color: #0f0; padding: 15px; height: 250px; overflow-y: scroll; font-family: monospace; border-radius: 5px; border: 1px solid #444; white-space: pre-wrap; margin-top: 15px; }
        .result-box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #2ecc71; margin: 10px 0; font-size: 18px; }
        h1 { color: #2ecc71; text-align: center; }
    </style>
</head>
<body>
    <h1>Minecraft Music Disc Synchronizer</h1>
    <div id="clocks"></div>
    
    <div class="result-box">
        <strong>Cycle LCM:</strong> <span id="lcm-display">--</span><br>
        <strong>Sync Progress:</strong> <span id="status-display">Initializing Engine...</span>
    </div>

    <div id="output">System Log: Waiting for Wasm...</div>

    <script>
        const discData = {"11":1441,"Creator MB":1481,"Mellohi":1941,"Lava Chicken":2701,"Pigstep":3001,"Stal":3021,"Far":3501,"Tears":3521,"Creator":3541,"13":3581,"5":3581,"Cat":3721,"Chirp":3721,"Strad":3781,"Otherside":3921,"Mall":3961,"Relic":4381,"Wait":4781,"Ward":5041,"Precipice":6001,"Blocks":6921};

        // UI Builder
        for(let i=1; i<=8; i++) {
            document.getElementById('clocks').innerHTML += `
                <div class="clock-card">
                    <div class="field-group">
                        <strong>Disc</strong>
                        <select class="disc-select" id="d${i}"><option value="">--Select--</option>
                        ${Object.keys(discData).map(k=>`<option value="${discData[k]}">${k}</option>`).join('')}</select>
                    </div>
                    <div class="field-group">
                        <strong>Off (X) / Offset (O)</strong>
                        <input type="number" class="off-val" id="x${i}" placeholder="Off Duration">
                        <input type="number" class="offset-val" id="o${i}" value="0">
                    </div>
                    <div class="field-group">
                        <strong>On: <span id="on${i}">--</span></strong>
                        <strong>Period: <span id="p${i}">--</span></strong>
                    </div>
                </div>`;
        }

        // Friend's BigInt Math for UI
        const gcd = (a, b) => b === 0n ? a : gcd(b, a % b);
        const lcm = (a, b) => (a * b) / gcd(a, b);

        var Module = {
            print: (t) => { document.getElementById('output').innerText += t + "\n"; },
            onRuntimeInitialized: () => {
                document.getElementById('status-display').innerText = "Fast Engine Ready.";
                document.getElementById('output').innerText = ">>> WASM LINKED <<<\n";
            }
        };

        function calculate() {
            let X = [], Y = [], O = [];
            let currentLCM = 1n;

            for(let i=1; i<=8; i++) {
                let yVal = document.getElementById(`d${i}`).value;
                let xVal = document.getElementById(`x${i}`).value;
                let oVal = document.getElementById(`o${i}`).value || 0;

                if(yVal && xVal) {
                    let biX = BigInt(xVal), biY = BigInt(yVal);
                    let period = biX + biY;
                    document.getElementById(`on${i}`).innerText = yVal;
                    document.getElementById(`p${i}`).innerText = period.toString();
                    
                    X.push(biX); Y.push(biY); O.push(BigInt(oVal));
                    currentLCM = lcm(currentLCM, period);
                }
            }

            if (X.length >= 2) {
                document.getElementById('lcm-display').innerText = currentLCM.toString();
                runWasmSolve(X, Y, O);
            }
        }

        function runWasmSolve(X, Y, O) {
            // Robust memory check
            const buffer = Module.HEAPU8 ? Module.HEAPU8.buffer : (Module.asmMemory ? Module.asmMemory.buffer : null);
            
            if (!buffer) {
                setTimeout(() => runWasmSolve(X, Y, O), 100); // Retry in 100ms if not ready
                return;
            }

            try {
                const count = X.length;
                const ptrX = Module._malloc(count * 8), ptrY = Module._malloc(count * 8), ptrO = Module._malloc(count * 8);
                const view = new DataView(buffer);
                
                for(let i=0; i<count; i++) {
                    view.setBigUint64(ptrX + (i * 8), X[i], true);
                    view.setBigUint64(ptrY + (i * 8), Y[i], true);
                    view.setBigUint64(ptrO + (i * 8), O[i], true);
                }

                Module.ccall('solve', null, ['number', 'number', 'number', 'number'], [count, ptrX, ptrY, ptrO]);
                Module._free(ptrX); Module._free(ptrY); Module._free(ptrO);
            } catch(e) { console.error("Wasm Bridge Error:", e); }
        }

        // Real-time listeners from friend's logic
        document.addEventListener("input", calculate);
    </script>
    <script async src="clock.js"></script>
</body>
</html>

