<!DOCTYPE html>
<html>
<head>
    <title>Minecraft Clock Synchronizer</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; max-width: 900px; margin: auto; padding: 20px; }
        .clock-card { background: #2d2d2d; padding: 20px; margin: 15px 0; border-radius: 12px; display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 20px; border: 1px solid #444; }
        .field-group { display: flex; flex-direction: column; gap: 8px; }
        input, select { padding: 12px; border-radius: 6px; border: 1px solid #555; background: #333; color: white; width: 100%; box-sizing: border-box; }
        button { width: 100%; padding: 18px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin: 20px 0; }
        #output { background: #000; color: #0f0; padding: 20px; height: 350px; overflow-y: scroll; font-family: monospace; border-radius: 8px; border: 2px solid #333; line-height: 1.4; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Minecraft Clock Synchronizer</h1>
    <div id="clocks"></div>
    <button id="calcBtn" onclick="runCalculator()" disabled>WAITING FOR ENGINE...</button>
    <div id="output">Initializing Fast Math Engine (Wasm)...</div>

    <script>
        const discData = {"Custom":0, "5":3581, "11":1441, "13":3581, "blocks":6921, "cat":3721, "chirp":3721, "creator":3541, "creator_music_box":1481, "far":3501, "mall":3961, "mellohi":1941, "otherside":3921, "pigstep":3001, "precipice":6001, "relic":4381, "stal":3021, "strad":3781, "tears":3521, "wait":4781, "ward":5041, "lava_chicken":2701};

        for(let i=1; i<=8; i++) {
            document.getElementById('clocks').innerHTML += `
                <div class="clock-card">
                    <div class="field-group">
                        <strong>Clock ${i} Disc</strong>
                        <select id="sel${i}" onchange="setDisc(${i}, this.value)">
                            ${Object.keys(discData).map(k=>`<option value="${discData[k]}">${k}</option>`).join('')}
                        </select>
                    </div>
                    <div class="field-group">
                        <strong>Off Duration (X)</strong>
                        <input type="number" id="x${i}" oninput="calcPeriod(${i})">
                        <strong>Offset (O)</strong>
                        <input type="number" id="o${i}" value="0">
                    </div>
                    <div class="field-group">
                        <strong>On Duration (Y)</strong>
                        <input type="number" id="y${i}" oninput="calcPeriod(${i})">
                        <strong>Total Period</strong>
                        <input type="text" id="p${i}" readonly>
                    </div>
                </div>`;
        }

        function setDisc(id, val) {
            if (val != 0) {
                document.getElementById(`x${id}`).value = val;
                calcPeriod(id);
            }
        }

        function calcPeriod(id) {
            let x = parseInt(document.getElementById(`x${id}`).value) || 0;
            let y = parseInt(document.getElementById(`y${id}`).value) || 0;
            document.getElementById(`p${id}`).value = (x > 0 && y > 0) ? (x + y) : "";
        }

        var Module = {
            print: (t) => { document.getElementById('output').innerText += t + "\n"; },
            onRuntimeInitialized: () => { 
                document.getElementById('output').innerText = ">>> ENGINE READY: FAST MATH ENABLED <<<\n";
                document.getElementById('calcBtn').disabled = false;
                document.getElementById('calcBtn').innerText = "CALCULATE ABSOLUTE FIRST TICK";
            }
        };

        function runCalculator() {
            try {
                // Verification of memory bridge readiness
                if (!Module.HEAPU8) throw new Error("Wasm memory not yet initialized.");

                let X = [], Y = [], O = [];
                for(let i=1; i<=8; i++) {
                    let x = document.getElementById(`x${i}`).value, y = document.getElementById(`y${i}`).value;
                    if(x && y) { 
                        X.push(BigInt(x)); Y.push(BigInt(y)); 
                        O.push(BigInt(document.getElementById(`o${i}`).value || 0)); 
                    }
                }
                if (X.length < 2) return Module.print("Error: Select at least 2 clocks.");

                Module.print("\n--- STARTING FAST CALCULATION ---");
                const count = X.length;
                const ptrX = Module._malloc(count * 8), ptrY = Module._malloc(count * 8), ptrO = Module._malloc(count * 8);
                
                // Using DataView to bypass browser-specific BigInt alignment issues
                const view = new DataView(Module.HEAPU8.buffer);
                for(let i=0; i<count; i++) {
                    view.setBigUint64(ptrX + (i * 8), X[i], true);
                    view.setBigUint64(ptrY + (i * 8), Y[i], true);
                    view.setBigUint64(ptrO + (i * 8), O[i], true);
                }

                Module.ccall('solve', null, ['number', 'number', 'number', 'number'], [count, ptrX, ptrY, ptrO]);
                Module._free(ptrX); Module._free(ptrY); Module._free(ptrO);
                Module.print("--- Process Complete ---");
            } catch(e) { Module.print("Error: " + e.message); }
        }
    </script>
    <script async src="clock.js"></script>
</body>
</html>
